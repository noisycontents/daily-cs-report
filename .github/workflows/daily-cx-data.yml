name: SM-CX Daily Stats Collection

# ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 10:20 (UTC 01:20) ìë™ ì‹¤í–‰
on:
  schedule:
    - cron: '20 1 * * *'  # UTC 01:20 = KST 10:20
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  collect-daily-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ğŸš€ SM-CX Daily Stats ìˆ˜ì§‘ ì‹¤í–‰
        env:
          # WordPress OAuth2 ì„¤ì •
          WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
          WP_CLIENT_ID: ${{ secrets.WP_CLIENT_ID }}
          WP_CLIENT_SECRET: ${{ secrets.WP_CLIENT_SECRET }}
          
          # Google Analytics 4 ì„¤ì •
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_DEVELOPER_TOKEN: ${{ secrets.GOOGLE_DEVELOPER_TOKEN }}
          GOOGLE_CUSTOMER_ID: ${{ secrets.GOOGLE_CUSTOMER_ID }}
          GOOGLE_CLIENT_CUSTOMER_ID: ${{ secrets.GOOGLE_CLIENT_CUSTOMER_ID }}
          
          # Supabase ì„¤ì •
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "ğŸš€ SM-CX Daily Stats ìˆ˜ì§‘ ì‹œì‘ ($(date '+%Y-%m-%d %H:%M:%S %Z'))"
          node scripts/fetch-and-push.js
          echo "âœ… SM-CX Daily Stats ìˆ˜ì§‘ ì™„ë£Œ ($(date '+%Y-%m-%d %H:%M:%S %Z'))"
          
      - name: ğŸ“ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
        run: |
          if [ $? -eq 0 ]; then
            echo "âœ… SUCCESS: ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥ ì„±ê³µ"
          else
            echo "âŒ FAILED: ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
            exit 1
          fi 
