name: Daily CX Stats Collection (SM & DOK)

# ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 8:00 (UTC 23:00) ìë™ ì‹¤í–‰
on:
  schedule:
    - cron: '0 23 * * *'  # UTC 23:00 = KST 08:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  collect-daily-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ§¹ ì™„ì „í•œ í™˜ê²½ ì •ë¦¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          # npm ì™„ì „ ì •ë¦¬
          npm cache clean --force
          rm -rf node_modules package-lock.json ~/.npm
          
          # Google ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ ì™„ì „ ì œê±°
          unset GOOGLE_APPLICATION_CREDENTIALS
          unset GOOGLE_CLOUD_PROJECT
          unset GCLOUD_PROJECT
          unset GOOGLE_CLIENT_EMAIL
          unset GOOGLE_PRIVATE_KEY
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          npm install
          
          # ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
          echo "=== ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ëª©ë¡ ==="
          ls node_modules/ | grep -i google || echo "Google íŒ¨í‚¤ì§€ ì—†ìŒ"
          
          # Google ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°•ì œ ì œê±°
          echo "=== Google ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°•ì œ ì œê±° ==="
          rm -rf node_modules/google-auth-library
          rm -rf node_modules/google-gax
          rm -rf node_modules/@google-analytics
          rm -rf node_modules/@google-cloud
          rm -rf node_modules/googleapis
          find node_modules -name "*google*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # ìµœì¢… í™•ì¸
          echo "=== ìµœì¢… Google íŒ¨í‚¤ì§€ í™•ì¸ ==="
          find node_modules -name "*google*" -type d || echo "âœ… Google íŒ¨í‚¤ì§€ ì™„ì „ ì œê±°"
        
      - name: ğŸš€ Daily CX Stats ìˆ˜ì§‘ ì‹¤í–‰ (SM & DOK)
        env:
          # SM-CX WordPress OAuth2 ì„¤ì •
          WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
          WP_CLIENT_ID: ${{ secrets.WP_CLIENT_ID }}
          WP_CLIENT_SECRET: ${{ secrets.WP_CLIENT_SECRET }}
          
          # DOK-CX WordPress OAuth2 ì„¤ì •
          DOK_WP_BASE_URL: ${{ secrets.DOK_WP_BASE_URL }}
          DOK_WP_CLIENT_ID: ${{ secrets.DOK_WP_CLIENT_ID }}
          DOK_WP_CLIENT_SECRET: ${{ secrets.DOK_WP_CLIENT_SECRET }}
          
          # SM-CX Google Analytics 4 ì„¤ì •
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          
          # DOK-CX Google Analytics 4 ì„¤ì •
          DOK_GA4_PROPERTY_ID: ${{ secrets.DOK_GA4_PROPERTY_ID }}
          
          # Supabase ì„¤ì • (ê³µí†µ)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          # ADC(ê¸°ë³¸ ìê²©ì¦ëª…) ë¹„í™œì„±í™”ë¥¼ ìœ„í•œ ì•ˆì „ì¥ì¹˜
          GOOGLE_APPLICATION_CREDENTIALS: ""
          GOOGLE_CLOUD_PROJECT: ""
          GCLOUD_PROJECT: ""
          # Node.js Google ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹„í™œì„±í™”
          GOOGLE_AUTH_DISABLE_SSL: "true"
        run: |
          # ì‹¤í–‰ ì „ Google ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¬í™•ì¸ ë° ì œê±°
          echo "=== ì‹¤í–‰ ì „ Google ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¬ì œê±° ==="
          rm -rf node_modules/google-auth-library node_modules/google-gax node_modules/@google-* node_modules/googleapis 2>/dev/null || true
          find node_modules -name "*google*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "ğŸš€ Daily CX Stats ìˆ˜ì§‘ ì‹œì‘ ($(date '+%Y-%m-%d %H:%M:%S %Z'))"
          echo "ğŸ“… KST ê¸°ì¤€ í˜„ì¬ ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')"
          
          echo ""
          echo "=== ğŸ¢ SM-CX ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ ==="
          node scripts/fetch-and-push.js
          SM_EXIT_CODE=$?
          
          echo ""
          echo "=== ğŸ‡©ğŸ‡ª DOK-CX ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ ==="
          node scripts/fetch-and-push-dok.js
          DOK_EXIT_CODE=$?
          
          echo ""
          echo "=== ğŸ“Š ìˆ˜ì§‘ ê²°ê³¼ ìš”ì•½ ==="
          if [ $SM_EXIT_CODE -eq 0 ]; then
            echo "âœ… SM-CX: ì„±ê³µ"
          else
            echo "âŒ SM-CX: ì‹¤íŒ¨ (Exit Code: $SM_EXIT_CODE)"
          fi
          
          if [ $DOK_EXIT_CODE -eq 0 ]; then
            echo "âœ… DOK-CX: ì„±ê³µ"
          else
            echo "âŒ DOK-CX: ì‹¤íŒ¨ (Exit Code: $DOK_EXIT_CODE)"
          fi
          
          echo "âœ… Daily CX Stats ìˆ˜ì§‘ ì™„ë£Œ ($(date '+%Y-%m-%d %H:%M:%S %Z'))"
          
          # ì ì–´ë„ í•˜ë‚˜ëŠ” ì„±ê³µí•´ì•¼ í•¨
          if [ $SM_EXIT_CODE -ne 0 ] && [ $DOK_EXIT_CODE -ne 0 ]; then
            echo "âŒ ëª¨ë“  ë¸Œëœë“œ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
            exit 1
          fi
          
      - name: ğŸ“ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
        run: |
          echo "ğŸ“Š Daily CX Stats Collection ì›Œí¬í”Œë¡œìš° ì™„ë£Œ"
          echo "ğŸ“… ì™„ë£Œ ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S %Z')" 
